#include <ros/ros.h>
#include <nav_msgs/Odometry.h>

geometry_msgs::PoseStamped curr_pose;
geometry_msgs::PoseStamped prev_pose;
geometry_msgs::PoseStamped tf_pose;

void current_position_callback(const geometry_msgs::PoseStamped &msg){

    geometry_msgs::PoseStamped curr_pose;
    curr_pose.pose.position.x = msg.pose.position.x;
    curr_pose.pose.position.y = msg.pose.position.y;

}

double delta_x, delta_y;
delta_x = delta_y = 0.0;

double seta_angle;
prev_pose.pose.pose.x = curr_pose.pose.position.x;
prev_pose.pose.pose.y = curr_pose.pose.position.y;

void tf_calculate(){

    delta_x = curr_pose.pose.position.x - prev_pose.pose.pose.x;
    delta_y = curr_pose.pose.position.y - prev_pose.pose.pose.y;
    seta_angle = atan2(delta_y, delta_x);

    tf_pose.pose.position.x = delta_x * cos(seta_angle) - delta_y * sin(seta_angle);
    tf_pose.pose.position.y = delta_x * sin(seta_angle) + delta_y * cos(seta_angle);

    prev_pose.pose.pose.x = curr_pose.pose.position.x;
}

int main(int argc, char **argv)
{
    ros::init(argc, argv, "odometry_publisher_node");

    ros::NodeHandle n;

    ros::Publisher odom_pub = n.advertise<nav_msgs::Odometry>("odom", 1);
    ros::Subscriber sub = n.subscribe("initial_2d", 1, current_position_callback);

    nav_msgs::Odometry odom;
    odom.header.frame_id = "odom";
    odom.child_frame_id = "base_footprint";
    //odom.pose.pose.position.x = real_value;
    odom.pose.pose.position.x = curr_pose.pose.position.x;
    odom.pose.pose.position.y = curr_pose.pose.position.y;
    odom.pose.pose.position.z = 0.0;

    odom.pose.pose.orientation.x = 0.0;
    odom.pose.pose.orientation.y = 0.0;
    odom.pose.pose.orientation.z = 0.0;
    odom.pose.pose.orientation.w = 1.0;

    odom.twist.twist.linear.x = 0.0;
    odom.twist.twist.linear.y = 0.0;
    odom.twist.twist.linear.z = 0.0;

    odom.twist.twist.angular.x = 0.0;
    odom.twist.twist.angular.y = 0.0;
    odom.twist.twist.angular.z = 1.0;

    ros::Rate loop_rate(10);
    while (ros::ok())
    {
        tf_calculate();

        odom.header.stamp = ros::Time::now();

        odom.pose.pose.position.x += tf_pose.pose.position.x;
        odom.pose.pose.position.y += tf_pose.pose.position.y;
        odom.pose.pose.orientation.z = seta_angle;

        odom_pub.publish(odom);
        loop_rate.sleep();

    }

    ros::spin();
}